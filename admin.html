<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mastering Logic | Admin Terminal</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

    <nav>
        <div class="nav-content">
            <a href="/" class="logo-main">TERMINAL<span>.LOGIC</span></a>
            <div id="heuristic-node" class="status-pill">
                <div class="status-dot"></div>
                <span id="node-type">ANALYZING_SYSTEM...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <section id="auth-gate" class="card-frame" style="max-width:550px; margin: 40px auto; text-align:center;">
            <h1>LOGIN</h1>
            <p style="color:var(--txt-muted); margin-bottom:40px;">Please authenticate to access the architectural core.</p>
            
            <div style="text-align:left;">
                <label style="font-size:0.7rem; font-weight:900; color:var(--p-brand);">ADMIN_IDENTIFICATION</label>
                <input type="email" id="email" class="terminal-input" placeholder="admin@masteringlogic.net">
                
                <label style="font-size:0.7rem; font-weight:900; color:var(--p-brand);">SECURITY_KEY</label>
                <input type="password" id="password" class="terminal-input" placeholder="••••••••••••">
            </div>
            
            <button id="auth-trigger" class="btn-execute">Initialize Session</button>
            <p id="auth-error" style="color:var(--d-brand); font-size:0.8rem; margin-top:20px; display:none;"></p>
        </section>

        <main id="admin-hub" style="display:none;">
            <div class="logic-grid">
                
                <div class="card-frame">
                    <h2>Project Architect</h2>
                    <p style="font-size:0.85rem; color:var(--txt-muted); margin-bottom:25px;">Deploy and modify primary application nodes.</p>
                    
                    <input type="hidden" id="bot-doc-id">
                    
                    <input type="text" id="bot-name" class="terminal-input" placeholder="Application Handle">
                    <textarea id="bot-description" class="terminal-input" style="height:140px; resize:none;" placeholder="System description and functional overview..."></textarea>
                    
                    <label style="font-size:0.65rem; color:var(--p-brand); font-weight:900; display:block; margin-bottom:10px;">ENGINEER ASSIGNMENTS</label>
                    <div id="personnel-checklist" class="terminal-input" style="height:150px; overflow-y:auto; padding:20px;">
                        </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                        <input type="number" id="bot-users" class="terminal-input" placeholder="User Scaling">
                        <input type="number" id="bot-nodes" class="terminal-input" placeholder="Node Count">
                    </div>

                    <input type="text" id="bot-avatar-url" class="terminal-input" placeholder="Asset URL (Image)">
                    <input type="text" id="bot-invite-url" class="terminal-input" placeholder="System Access URL">
                    
                    <button id="save-bot-btn" class="btn-execute">Commit Project</button>
                </div>

                <div class="card-frame">
                    <h2>Identity & Audit</h2>
                    <p style="font-size:0.85rem; color:var(--txt-muted); margin-bottom:25px;">Manage core engineers and monitor system changes.</p>
                    
                    <input type="hidden" id="staff-doc-id">
                    <input type="text" id="staff-name" class="terminal-input" placeholder="Personnel Identity">
                    <input type="text" id="staff-role" class="terminal-input" placeholder="Functional Role (e.g. Lead Engineer)">
                    <input type="text" id="staff-avatar-url" class="terminal-input" placeholder="Identity Avatar URL">
                    
                    <button id="save-staff-btn" class="btn-execute">Sync Personnel</button>

                    <div class="mt-40">
                        <h3 style="display:flex; justify-content:space-between; align-items:center;">
                            Audit Logs
                            <span style="font-family:'JetBrains Mono'; font-size:0.6rem; color:var(--txt-low);">LIVE_FEED</span>
                        </h3>
                        <div id="audit-feed" class="audit-log-box mt-20">
                            </div>
                    </div>
                </div>

            </div>

            <div class="logic-grid mt-40">
                <div class="card-frame">
                    <h3>Project Registry</h3>
                    <div id="reg-list-bots" class="mt-20"></div>
                </div>
                <div class="card-frame">
                    <h3>Personnel Registry</h3>
                    <div id="reg-list-staff" class="mt-20"></div>
                </div>
            </div>
        </main>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase Configuration Node
        const firebaseConfig = { 
            apiKey: "AIzaSyBxZOiNLQixhfEK5_U-yf1wDi7f1oyM9NQ", 
            authDomain: "portfolio-a8de0.firebaseapp.com", 
            projectId: "portfolio-a8de0", 
            appId: "1:352813143804:web:9ab1d0f59f38d0b519e979" 
        };

        const logicApp = initializeApp(firebaseConfig);
        const logicAuth = getAuth(logicApp);
        const logicDB = getFirestore(logicApp);

        /**
         * System Heuristics: Identify Access Node Type
         */
        const detectDevice = () => {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            const nodeLabel = document.getElementById('node-type');
            nodeLabel.innerText = isMobile ? "MOBILE_ACCESS_NODE" : "WORKSTATION_NODE";
            if(isMobile) {
                document.body.style.fontSize = "14px";
            }
        };

        /**
         * Audit Logging Module
         */
        const recordAuditLog = async (action, subject) => {
            try {
                await addDoc(collection(logicDB, "logs"), {
                    timestamp: new Date().toLocaleTimeString(),
                    action: action,
                    subject: subject,
                    created_at: serverTimestamp()
                });
            } catch (err) {
                console.error("Audit Failure:", err);
            }
        };

        /**
         * Firestore Real-time Data Sync
         */
        const initializeRealtimeData = () => {
            // Sync Audit Logs
            const logQuery = query(collection(logicDB, "logs"), orderBy("created_at", "desc"), limit(20));
            onSnapshot(logQuery, (snapshot) => {
                const feed = document.getElementById('audit-feed');
                feed.innerHTML = "";
                snapshot.forEach(doc => {
                    const l = doc.data();
                    feed.innerHTML += `
                        <div class="log-entry">
                            <span class="time">[${l.timestamp}]</span>
                            <span class="action">${l.action}</span>
                            <span class="target">${l.subject}</span>
                        </div>
                    `;
                });
            });

            // Sync Personnel Registry
            onSnapshot(collection(logicDB, "team"), (snapshot) => {
                const checkList = document.getElementById('personnel-checklist');
                const regList = document.getElementById('reg-list-staff');
                checkList.innerHTML = "";
                regList.innerHTML = "";

                snapshot.forEach(d => {
                    const m = d.data();
                    checkList.innerHTML += `<div style="margin-bottom:8px; display:flex; gap:10px;"><input type="checkbox" name="assignees" value="${d.id}"> ${m.name}</div>`;
                    regList.innerHTML += `
                        <div class="registry-item">
                            <span style="font-weight:700;">${m.name}</span>
                            <div>
                                <button class="btn-ctrl edit-btn" onclick="triggerStaffEdit('${d.id}')">EDIT</button>
                                <button class="btn-ctrl del-btn" onclick="triggerStaffDelete('${d.id}')">X</button>
                            </div>
                        </div>
                    `;
                });
            });

            // Sync Project Registry
            onSnapshot(collection(logicDB, "bots"), (snapshot) => {
                const regList = document.getElementById('reg-list-bots');
                regList.innerHTML = "";
                snapshot.forEach(d => {
                    const b = d.data();
                    regList.innerHTML += `
                        <div class="registry-item">
                            <span style="font-weight:700;">${b.name}</span>
                            <div>
                                <button class="btn-ctrl edit-btn" onclick="triggerBotEdit('${d.id}')">EDIT</button>
                                <button class="btn-ctrl del-btn" onclick="triggerBotDelete('${d.id}')">X</button>
                            </div>
                        </div>
                    `;
                });
            });
        };

        /**
         * Authentication Pipeline
         */
        document.getElementById('auth-trigger').onclick = () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const errBox = document.getElementById('auth-error');

            signInWithEmailAndPassword(logicAuth, email, pass)
                .catch(err => {
                    errBox.innerText = "ACCESS_DENIED: Invalid Credentials";
                    errBox.style.display = "block";
                });
        };

        onAuthStateChanged(logicAuth, user => {
            if(user) {
                document.getElementById('auth-gate').style.display = 'none';
                document.getElementById('admin-hub').style.display = 'block';
                initializeRealtimeData();
                detectDevice();
            }
        });

        /**
         * Project CRUD Logic
         */
        window.commitBot = async () => {
            const docId = document.getElementById('bot-doc-id').value;
            const name = document.getElementById('bot-name').value;
            const payload = {
                name: name,
                desc: document.getElementById('bot-description').value,
                users: document.getElementById('bot-users').value,
                servers: document.getElementById('bot-nodes').value,
                avatar: document.getElementById('bot-avatar-url').value,
                invite: document.getElementById('bot-invite-url').value,
                assignees: Array.from(document.querySelectorAll('input[name="assignees"]:checked')).map(c => c.value)
            };

            if(docId) {
                await updateDoc(doc(logicDB, "bots", docId), payload);
                await recordAuditLog("PROJECT_MODIFIED", name);
            } else {
                await addDoc(collection(logicDB, "bots"), payload);
                await recordAuditLog("PROJECT_DEPLOYED", name);
            }
            location.reload();
        };
        document.getElementById('save-bot-btn').onclick = window.commitBot;

        window.triggerBotEdit = async (id) => {
            const snap = await getDoc(doc(logicDB, "bots", id));
            const b = snap.data();
            document.getElementById('bot-doc-id').value = id;
            document.getElementById('bot-name').value = b.name;
            document.getElementById('bot-description').value = b.desc;
            document.getElementById('bot-users').value = b.users;
            document.getElementById('bot-nodes').value = b.servers;
            document.getElementById('bot-avatar-url').value = b.avatar;
            document.getElementById('bot-invite-url').value = b.invite;
            document.querySelectorAll('input[name="assignees"]').forEach(c => c.checked = b.assignees?.includes(c.value));
            document.getElementById('save-bot-btn').innerText = "Update Application";
        };

        window.triggerBotDelete = async (id) => {
            if(confirm("Confirm deletion of system node?")) {
                const snap = await getDoc(doc(logicDB, "bots", id));
                await recordAuditLog("PROJECT_TERMINATED", snap.data().name);
                await deleteDoc(doc(logicDB, "bots", id));
            }
        };

        /**
         * Personnel CRUD Logic
         */
        window.commitStaff = async () => {
            const docId = document.getElementById('staff-doc-id').value;
            const name = document.getElementById('staff-name').value;
            const payload = {
                name: name,
                role: document.getElementById('staff-role').value,
                avatar: document.getElementById('staff-avatar-url').value
            };

            if(docId) {
                await updateDoc(doc(logicDB, "team", docId), payload);
                await recordAuditLog("IDENTITY_SYNCED", name);
            } else {
                await addDoc(collection(logicDB, "team"), payload);
                await recordAuditLog("IDENTITY_CREATED", name);
            }
            location.reload();
        };
        document.getElementById('save-staff-btn').onclick = window.commitStaff;

        window.triggerStaffEdit = async (id) => {
            const snap = await getDoc(doc(logicDB, "team", id));
            const m = snap.data();
            document.getElementById('staff-doc-id').value = id;
            document.getElementById('staff-name').value = m.name;
            document.getElementById('staff-role').value = m.role;
            document.getElementById('staff-avatar-url').value = m.avatar;
            document.getElementById('save-staff-btn').innerText = "Update Identity";
        };

        window.triggerStaffDelete = async (id) => {
            if(confirm("Remove personnel from registry?")) {
                const snap = await getDoc(doc(logicDB, "team", id));
                await recordAuditLog("IDENTITY_PURGED", snap.data().name);
                await deleteDoc(doc(logicDB, "team", id));
            }
        };

    </script>
</body>
</html>
